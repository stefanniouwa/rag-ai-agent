# Phase 1: Data Layer and Infrastructure Setup

## Brief Description

Set up the foundational data layer and infrastructure for the RAG AI Agent webapp, including database schema, core data models, configuration management, and basic testing framework. This phase establishes the foundation that all other components will build upon.

## Files to Create:
- `requirements.txt` - Python dependencies
- `pyproject.toml` - Project configuration and dev dependencies 
- `.env.example` - Environment variable template
- `src/db.py` - Supabase client and database helpers
- `src/models.py` - Data models and type definitions
- `supabase/migrations/001_initial_schema.sql` - Database schema migration
- `tests/conftest.py` - Pytest configuration and fixtures
- `tests/test_db.py` - Database connection and basic operation tests

## Database Schema (Supabase):
```sql
-- documents table
CREATE TABLE documents (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    filename TEXT NOT NULL,
    uploaded_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- vectors table with pgvector
CREATE TABLE vectors (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    doc_id UUID REFERENCES documents(id) ON DELETE CASCADE,
    chunk_id INTEGER NOT NULL,
    content TEXT NOT NULL,
    embedding VECTOR(1536),
    metadata JSONB
);

-- chat_histories table
CREATE TABLE chat_histories (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    session_id TEXT NOT NULL,
    turn_index INTEGER NOT NULL,
    user_message TEXT NOT NULL,
    ai_response TEXT NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Enable pgvector extension
CREATE EXTENSION IF NOT EXISTS vector;

-- Create indexes
CREATE INDEX idx_vectors_doc_id ON vectors(doc_id);
CREATE INDEX idx_vectors_embedding ON vectors USING ivfflat (embedding vector_cosine_ops);
CREATE INDEX idx_chat_histories_session_id ON chat_histories(session_id);
```

## Key Data Models:
- `Document` dataclass with id, filename, uploaded_at
- `VectorChunk` dataclass with id, doc_id, chunk_id, content, embedding, metadata
- `ChatMessage` dataclass with session_id, turn_index, user_message, ai_response, created_at

## Environment Variables Required:
- `SUPABASE_URL` - Supabase project URL
- `SUPABASE_ANON_KEY` - Supabase anonymous key
- `SUPABASE_SERVICE_KEY` - Supabase service role key for admin operations
- `OPENAI_API_KEY` - OpenAI API key for embeddings and chat

## Key Technical Details:
- Use pgvector extension for efficient vector storage and similarity search
- Implement proper foreign key relationships with cascade delete
- Set up ivfflat indexing for optimal vector search performance
- Configure proper data types for embeddings (VECTOR(1536) for OpenAI text-embedding-3-small)
- Establish testing framework with pytest and proper fixtures for database testing